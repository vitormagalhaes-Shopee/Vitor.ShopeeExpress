<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Logistics Ops | Intelligence Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        body { background-color: #F3F4F6; font-family: 'Inter', sans-serif; color: #1E293B; }
        .brand-blue { color: #0284C7; }
        .bg-brand { background-color: #0284C7; }
        .dashboard-card { 
            background: white; 
            border-radius: 12px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #E2E8F0;
        }
        .loader { border-top-color: #0284C7; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        select { border: 1px solid #E2E8F0; border-radius: 8px; padding: 4px 8px; font-size: 0.75rem; font-weight: 600; outline: none; }
    </style>
</head>
<body>

    <div id="loading" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-slate-50">
        <div class="loader rounded-full border-4 border-slate-200 h-12 w-12 mb-4"></div>
        <p class="text-sm font-bold text-slate-500 uppercase tracking-widest">Carregando Operações...</p>
    </div>

    <header class="bg-white border-b border-slate-200 p-4 sticky top-0 z-40">
        <div class="max-w-[1600px] mx-auto flex flex-col lg:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-brand rounded-lg flex items-center justify-center text-white shadow-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                </div>
                <div>
                    <h1 class="font-extrabold text-lg tracking-tight leading-none uppercase">Logistics <span class="brand-blue">Intelligence</span></h1>
                    <span class="text-[10px] font-bold text-slate-400 uppercase tracking-tighter">Control Tower v2.0</span>
                </div>
            </div>
            
            <div class="flex flex-wrap items-center gap-2">
                <select id="filter-date-range">
                    <option value="7">Últimos 7 dias</option>
                    <option value="15">Últimos 15 dias</option>
                    <option value="30">Últimos 30 dias</option>
                </select>
                <select id="filter-hub"><option value="">Todos os Hubs</option></select>
                <select id="filter-transp"><option value="">Todas Transportadoras</option></select>
                <select id="filter-perfil"><option value="">Todos Perfis</option></select>
                <button onclick="resetFilters()" class="text-xs font-bold text-slate-400 hover:text-red-500 px-2 transition-colors">LIMPAR</button>
            </div>
        </div>
    </header>

    <main class="max-w-[1600px] mx-auto p-4 lg:p-6">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <div class="dashboard-card p-5 border-t-4 border-blue-600">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-[10px] font-bold text-slate-400 uppercase mb-1">Frota Total</p>
                        <h3 id="kpi-total" class="text-3xl font-black text-slate-800 tracking-tight">0</h3>
                    </div>
                    <div class="p-2 bg-blue-50 rounded-lg text-blue-600">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="3" width="15" height="13"></rect><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon><circle cx="5.5" cy="18.5" r="2.5"></circle><circle cx="18.5" cy="18.5" r="2.5"></circle></svg>
                    </div>
                </div>
            </div>

            <div class="dashboard-card p-5 border-t-4 border-blue-400">
                <p class="text-[10px] font-bold text-slate-400 uppercase mb-1">Top Partner</p>
                <h3 id="kpi-top-transp" class="text-xl font-bold text-slate-700 truncate">-</h3>
                <p id="kpi-top-transp-val" class="text-xs text-blue-500 font-bold">0 veículos</p>
            </div>

            <div class="dashboard-card p-5 border-t-4 border-blue-300">
                <p class="text-[10px] font-bold text-slate-400 uppercase mb-1">Mix Dominante (Modal)</p>
                <h3 id="kpi-top-perfil" class="text-xl font-bold text-slate-700">-</h3>
                <p id="kpi-top-perfil-val" class="text-xs text-blue-500 font-bold">0% do total</p>
            </div>

            <div class="dashboard-card p-5 border-t-4 border-slate-300">
                <p class="text-[10px] font-bold text-slate-400 uppercase mb-1">Sincronização</p>
                <h3 id="sync-time" class="text-xl font-bold text-slate-700 uppercase">--:--</h3>
                <div class="flex items-center gap-1 mt-1">
                    <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                    <span class="text-[10px] font-bold text-green-600 uppercase">Dados em Tempo Real</span>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            <div class="dashboard-card p-6 lg:col-span-8">
                <div class="flex justify-between items-center mb-6">
                    <h4 class="font-bold text-slate-700 uppercase text-xs tracking-widest">Evolução Temporal da Frota</h4>
                    <div id="evolution-total" class="text-right">
                        <span class="text-[10px] font-bold text-slate-400 uppercase">Total no Período</span>
                        <p class="text-lg font-black text-blue-600 leading-none">0</p>
                    </div>
                </div>
                <div class="h-64"><canvas id="chart-evolution"></canvas></div>
            </div>

            <div class="dashboard-card p-6 lg:col-span-4">
                <h4 class="font-bold text-slate-700 uppercase text-xs tracking-widest mb-6">Mix por Perfil de Veículo</h4>
                <div class="h-64"><canvas id="chart-perfil"></canvas></div>
            </div>

            <div class="dashboard-card p-6 lg:col-span-4">
                <h4 class="font-bold text-slate-700 uppercase text-xs tracking-widest mb-6">Market Share Parceiros</h4>
                <div class="h-64"><canvas id="chart-transp-share"></canvas></div>
            </div>

            <div class="dashboard-card p-6 lg:col-span-4">
                <h4 class="font-bold text-slate-700 uppercase text-xs tracking-widest mb-6">Performance por Hub</h4>
                <div class="h-64"><canvas id="chart-hubs"></canvas></div>
            </div>

            <div class="dashboard-card p-6 lg:col-span-4">
                <h4 class="font-bold text-slate-700 uppercase text-xs tracking-widest mb-6">Distribuição AM vs DD</h4>
                <div class="h-64"><canvas id="chart-ciclo-comp"></canvas></div>
            </div>
        </div>
    </main>

    <script>
        const SHEET_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT4QgrRy659Pt4wBgeT987bFhfwSjnESxNSHJ-OWOZ_yxEu8mWmvWYdUH5Y-4EjowJspxOv9b4gkSB0/pub?gid=0&output=csv";
        
        let rawData = [];
        let charts = {};
        const BLUE_PALETTE = ['#0369a1', '#0ea5e9', '#38bdf8', '#7dd3fc', '#bae6fd', '#e0f2fe'];
        const SLATE_PALETTE = ['#475569', '#64748b', '#94a3b8', '#cbd5e1', '#e2e8f0'];

        const PERFIS_ORDEM = ["VUC", "PASSEIO", "MOTO", "VAN", "FIORINO", "VAN/KOMBI", "UTILITÁRIO"];

        async function init() {
            try {
                const response = await fetch(`${SHEET_CSV}&cache=${Date.now()}`);
                const csv = await response.text();
                const parsed = Papa.parse(csv, { header: true, skipEmptyLines: true }).data;
                
                // Limpeza Rigorosa
                rawData = parsed.filter(r => {
                    const t = String(r['TRANSPORTADORA'] || '').toUpperCase();
                    const p = String(r['PERFIL DO VEÍCULO'] || '').toUpperCase();
                    return t && t !== 'N/D' && !t.includes('#REF') && 
                           p && p !== 'N/D' && !p.includes('#REF') && p !== 'PERFIL DO VEÍCULO';
                }).map(r => ({
                    data: r['DATA'] || '',
                    ciclo: String(r['CICLO (AM / DD)'] || '').toUpperCase(),
                    hub: String(r['HUB'] || '').toUpperCase(),
                    transp: String(r['TRANSPORTADORA'] || '').trim().toUpperCase(),
                    perfil: String(r['PERFIL DO VEÍCULO'] || '').trim().toUpperCase(),
                    qtd: parseInt(String(r['QUANTIDADE DE VEÍCULOS'] || 0).replace(/\D/g, '')) || 0
                }));

                populateFilters();
                update();

                document.getElementById('loading').style.display = 'none';
                document.getElementById('sync-time').innerText = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            } catch (e) { console.error(e); }
        }

        function populateFilters() {
            const fill = (id, items) => {
                const el = document.getElementById(id);
                el.innerHTML = `<option value="">${el.options[0].text}</option>`;
                [...new Set(items)].sort().forEach(item => {
                    const opt = document.createElement('option');
                    opt.value = item; opt.innerText = item;
                    el.appendChild(opt);
                });
            };
            fill('filter-hub', rawData.map(d => d.hub));
            fill('filter-transp', rawData.map(d => d.transp));
            fill('filter-perfil', rawData.map(d => d.perfil));

            ['filter-hub', 'filter-transp', 'filter-perfil', 'filter-date-range'].forEach(id => {
                document.getElementById(id).addEventListener('change', update);
            });
        }

        function resetFilters() {
            ['filter-hub', 'filter-transp', 'filter-perfil'].forEach(id => document.getElementById(id).value = "");
            document.getElementById('filter-date-range').value = "7";
            update();
        }

        function update() {
            const fHub = document.getElementById('filter-hub').value;
            const fTransp = document.getElementById('filter-transp').value;
            const fPerfil = document.getElementById('filter-perfil').value;
            const fDays = parseInt(document.getElementById('filter-date-range').value);

            let filtered = rawData.filter(d => 
                (fHub === "" || d.hub === fHub) &&
                (fTransp === "" || d.transp === fTransp) &&
                (fPerfil === "" || d.perfil === fPerfil)
            );

            // Filtro de Data (Últimos X dias baseado na data máxima dos dados)
            const uniqueDates = [...new Set(rawData.map(d => d.data))].sort((a,b) => {
                return new Date(a.split('/').reverse().join('-')) - new Date(b.split('/').reverse().join('-'));
            });
            const lastDates = uniqueDates.slice(-fDays);
            const dateFiltered = filtered.filter(d => lastDates.includes(d.data));

            renderKPIs(filtered, dateFiltered);
            renderCharts(dateFiltered, lastDates);
        }

        function renderKPIs(allData, periodData) {
            const total = periodData.reduce((acc, curr) => acc + curr.qtd, 0);
            document.getElementById('kpi-total').innerText = total.toLocaleString('pt-BR');
            document.getElementById('evolution-total').querySelector('p').innerText = total.toLocaleString('pt-BR');

            // Top Transp
            const transps = periodData.reduce((acc, d) => { acc[d.transp] = (acc[d.transp] || 0) + d.qtd; return acc; }, {});
            const topT = Object.entries(transps).sort((a,b) => b[1] - a[1])[0] || ["-", 0];
            document.getElementById('kpi-top-transp').innerText = topT[0];
            document.getElementById('kpi-top-transp-val').innerText = `${topT[1]} veículos`;

            // Top Perfil
            const perfis = periodData.reduce((acc, d) => { acc[d.perfil] = (acc[d.perfil] || 0) + d.qtd; return acc; }, {});
            const topP = Object.entries(perfis).sort((a,b) => b[1] - a[1])[0] || ["-", 0];
            const pctP = total > 0 ? ((topP[1] / total) * 100).toFixed(1) : 0;
            document.getElementById('kpi-top-perfil').innerText = topP[0];
            document.getElementById('kpi-top-perfil-val').innerText = `${pctP}% do mix total`;
        }

        function renderCharts(data, lastDates) {
            // 1. Evolução (Line)
            const evData = lastDates.map(date => data.filter(d => d.data === date).reduce((acc, curr) => acc + curr.qtd, 0));
            createChart('chart-evolution', 'line', lastDates, evData, { 
                fill: true, 
                borderColor: '#0284C7', 
                backgroundColor: 'rgba(2, 132, 199, 0.05)',
                tension: 0.3
            });

            // 2. Perfil (Bar Horizontal) - Ordem Específica
            const perfilMap = data.reduce((acc, d) => { acc[d.perfil] = (acc[d.perfil] || 0) + d.qtd; return acc; }, {});
            const perfilLabels = PERFIS_ORDEM.filter(p => perfilMap[p]);
            const perfilValues = perfilLabels.map(p => perfilMap[p]);
            createChart('chart-perfil', 'bar', perfilLabels, perfilValues, {
                indexAxis: 'y',
                backgroundColor: BLUE_PALETTE
            });

            // 3. Market Share (Bar Horizontal - Melhor que Doughnut para executivos)
            const transpMap = data.reduce((acc, d) => { acc[d.transp] = (acc[d.transp] || 0) + d.qtd; return acc; }, {});
            const topTransps = Object.entries(transpMap).sort((a,b) => b[1] - a[1]).slice(0, 5);
            createChart('chart-transp-share', 'bar', topTransps.map(x => x[0]), topTransps.map(x => x[1]), {
                indexAxis: 'y',
                backgroundColor: '#0369a1'
            });

            // 4. Hubs (Bar Vertical)
            const hubMap = data.reduce((acc, d) => { acc[d.hub] = (acc[d.hub] || 0) + d.qtd; return acc; }, {});
            const topHubs = Object.entries(hubMap).sort((a,b) => b[1] - a[1]).slice(0, 8);
            createChart('chart-hubs', 'bar', topHubs.map(x => x[0]), topHubs.map(x => x[1]), {
                backgroundColor: '#38bdf8'
            });

            // 5. Ciclo AM vs DD
            const amVal = data.filter(d => d.ciclo.includes('AM')).reduce((a,b) => a + b.qtd, 0);
            const ddVal = data.filter(d => d.ciclo.includes('DD')).reduce((a,b) => a + b.qtd, 0);
            createChart('chart-ciclo-comp', 'doughnut', ['Ciclo AM', 'Ciclo DD'], [amVal, ddVal], {
                backgroundColor: ['#0369a1', '#cbd5e1'],
                cutout: '70%'
            });
        }

        function createChart(id, type, labels, values, extra) {
            if (charts[id]) charts[id].destroy();
            const ctx = document.getElementById(id).getContext('2d');
            
            const config = {
                type: type,
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        borderWidth: 0,
                        borderRadius: 4,
                        ...extra
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { display: type === 'doughnut' },
                        tooltip: { backgroundColor: '#1e293b', padding: 12 }
                    },
                    scales: type === 'doughnut' ? {} : {
                        x: { grid: { display: false }, ticks: { font: { size: 9, weight: 'bold' } } },
                        y: { grid: { color: '#f1f5f9' }, ticks: { font: { size: 9 } } }
                    }
                }
            };
            charts[id] = new Chart(ctx, config);
        }

        init();
        setInterval(init, 600000); // 10 min
    </script>
</body>
</html>
