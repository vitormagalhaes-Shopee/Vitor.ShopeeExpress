<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Shopee Express | Logistics Intelligence Ops</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
body{font-family:'Inter',sans-serif;background:#F8F9FA;color:#2D2D2D}
.dashboard-card{background:#fff;border-radius:12px;border:1px solid #E5E7EB;box-shadow:0 4px 6px -1px rgba(0,0,0,.05)}
.loader{border-top-color:#EE4D2D;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>

<body>
<div id="loading" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-white">
<div class="loader border-8 border-gray-100 rounded-full w-16 h-16 mb-4"></div>
<strong>SHOPEE EXPRESS</strong>
</div>

<header class="bg-white border-b p-4 sticky top-0 z-40">
<div class="max-w-[1400px] mx-auto flex justify-between items-center">
<strong class="italic">LOGISTICS INTELLIGENCE</strong>
<div class="flex gap-2">
<select id="filter-hub" class="border px-3 py-1 rounded text-xs"><option value="">HUB</option></select>
<select id="filter-ciclo" class="border px-3 py-1 rounded text-xs"><option value="">CICLO</option></select>
<select id="filter-transp" class="border px-3 py-1 rounded text-xs"><option value="">TRANSPORTADORA</option></select>
<select id="filter-perfil" class="border px-3 py-1 rounded text-xs"><option value="">PERFIL</option></select>
</div>
</div>
</header>

<main class="max-w-[1400px] mx-auto p-6">

<!-- KPIs -->
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
<div class="dashboard-card p-4 border-l-4 border-orange-500">
<p class="text-xs text-gray-400 font-bold">FROTA TOTAL</p>
<h2 id="kpi-total" class="text-3xl font-black">—</h2>
</div>
<div class="dashboard-card p-4 border-l-4 border-blue-500">
<p class="text-xs text-gray-400 font-bold">VEÍCULOS POR TRANSPORTADORA</p>
<h2 id="kpi-transp" class="text-3xl font-black">—</h2>
</div>
<div class="dashboard-card p-4 border-l-4 border-indigo-500">
<p class="text-xs text-gray-400 font-bold">VEÍCULOS POR MODAL</p>
<h2 id="kpi-modal" class="text-3xl font-black">—</h2>
</div>
<div class="dashboard-card p-4 border-l-4 border-gray-300">
<p class="text-xs text-gray-400 font-bold">ÚLTIMA SYNC</p>
<h2 id="sync-time" class="text-xl font-black text-gray-500">--:--</h2>
</div>
</div>

<!-- EVOLUÇÃO -->
<div class="dashboard-card p-6 mb-6">
<div class="flex justify-between items-center mb-2">
<strong class="italic">EVOLUÇÃO DIÁRIA</strong>
<select id="filter-days" class="border rounded px-2 py-1 text-xs">
<option value="7">7 dias</option>
<option value="14">14 dias</option>
<option value="30">30 dias</option>
</select>
</div>
<p class="text-sm font-bold mb-2">Total no período: <span id="total-periodo">—</span></p>
<div class="h-64"><canvas id="chart-evolution"></canvas></div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
<div class="dashboard-card p-6">
<strong class="italic">PERFIL DE VEÍCULO</strong>
<div class="h-72"><canvas id="chart-perfil"></canvas></div>
</div>
<div class="dashboard-card p-6">
<strong class="italic">MARKET SHARE PARCEIROS</strong>
<div class="h-72"><canvas id="chart-transp"></canvas></div>
</div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
<div class="dashboard-card p-6">
<strong class="italic">VOLUME POR HUB</strong>
<div class="h-72"><canvas id="chart-hubs"></canvas></div>
</div>
<div class="dashboard-card p-6">
<strong class="italic">AM vs DD</strong>
<div class="h-72"><canvas id="chart-ciclo"></canvas></div>
</div>
</div>

</main>

<script>
const SHEET="https://docs.google.com/spreadsheets/d/e/2PACX-1vT4QgrRy659Pt4wBgeT987bFhfwSjnESxNSHJ-OWOZ_yxEu8mWmvWYdUH5Y-4EjowJspxOv9b4gkSB0/pub?gid=0&output=csv";
let raw=[],charts={};
const PERFIS=["VUC","PASSEIO","MOTO","VAN","FIORINO","VAN/KOMBI","UTILITÁRIO"];

function normalizeDate(v){
if(!v)return null;
if(!isNaN(v)&&v>30000)return new Date((v-25569)*86400*1000);
if(typeof v==="string"){
if(/^\d{2}\/\d{2}\/\d{4}$/.test(v)){let[d,m,y]=v.split("/");return new Date(`${y}-${m}-${d}`)}
if(/^\d{4}-\d{2}-\d{2}$/.test(v))return new Date(v)
}
const d=new Date(v);return isNaN(d)?null:d;
}
function clean(v){
if(!v)return null;
v=String(v).trim().toUpperCase();
if(v==="ND"||v==="#REF!")return null;
return v;
}

async function init(){
const csv=await fetch(SHEET+"&t="+Date.now()).then(r=>r.text());
const parsed=Papa.parse(csv,{header:true,skipEmptyLines:true}).data;

raw=parsed.map(r=>{
const perfil=clean(r["PERFIL DO VEÍCULO"]);
return{
date:normalizeDate(r["DATA"]),
hub:clean(r["HUB"]),
ciclo:clean(r["CICLO (AM / DD)"]),
transp:clean(r["TRANSPORTADORA"]),
perfil:PERFIS.includes(perfil)?perfil:null,
qtd:parseInt(String(r["QUANTIDADE DE VEÍCULOS"]||0).replace(/\D/g,""))||0
}
}).filter(d=>d.date&&d.qtd>0);

populate();
update();
document.getElementById("sync-time").innerText=new Date().toLocaleTimeString();
document.getElementById("loading").style.display="none";
}

function populate(){
["hub","ciclo","transp","perfil"].forEach(k=>{
const el=document.getElementById("filter-"+k);
[...new Set(raw.map(d=>d[k]).filter(Boolean))].forEach(v=>{
el.innerHTML+=`<option value="${v}">${v}</option>`;
});
el.onchange=update;
});
document.getElementById("filter-days").onchange=update;
}

function update(){
let d=[...raw];
["hub","ciclo","transp","perfil"].forEach(k=>{
const v=document.getElementById("filter-"+k).value;
if(v)d=d.filter(x=>x[k]===v);
});

const days=parseInt(filter-days.value);
const dates=d.map(x=>x.date).filter(x=>x instanceof Date);
if(dates.length){
const max=new Date(Math.max(...dates));
const min=new Date(max);min.setDate(min.getDate()-days+1);
d=d.filter(x=>x.date>=min);
}

updateKPIs(d);
renderCharts(d);
}

function updateKPIs(d){
if(!d.length){kpi-total.innerText=kpi-transp.innerText=kpi-modal.innerText=total-periodo.innerText="—";return;}
const total=d.reduce((a,b)=>a+b.qtd,0);
kpi-total.innerText=total.toLocaleString("pt-BR");
total-periodo.innerText=total.toLocaleString("pt-BR");
kpi-transp.innerText=total.toLocaleString("pt-BR");
kpi-modal.innerText=total.toLocaleString("pt-BR");
}

function renderCharts(d){
Object.values(charts).forEach(c=>c.destroy?.());

const dm={};d.forEach(x=>{const k=x.date.toLocaleDateString();dm[k]=(dm[k]||0)+x.qtd});
charts.e=new Chart(chart-evolution,{type:"line",data:{labels:Object.keys(dm),datasets:[{data:Object.values(dm),borderColor:"#EE4D2D",tension:.4}]},options:{plugins:{legend:{display:false}},scales:{x:{grid:{display:false}},y:{grid:{display:false}}}}});

const pm={};d.forEach(x=>x.perfil&&(pm[x.perfil]=(pm[x.perfil]||0)+x.qtd));
charts.p=new Chart(chart-perfil,{type:"bar",data:{labels:Object.keys(pm),datasets:[{data:Object.values(pm),backgroundColor:"#3B82F6"}]},options:{plugins:{legend:{display:false}}}});

const tm={};d.forEach(x=>x.transp&&(tm[x.transp]=(tm[x.transp]||0)+x.qtd));
const s=Object.entries(tm).sort((a,b)=>b[1]-a[1]);const top=s.slice(0,6);
const oth=s.slice(6).reduce((a,b)=>a+b[1],0);if(oth)top.push(["OUTROS",oth]);
charts.t=new Chart(chart-transp,{type:"doughnut",data:{labels:top.map(x=>x[0]),datasets:[{data:top.map(x=>x[1])}]}});
}

init();
</script>
</body>
</html>
