<script>
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT4QgrRy659Pt4wBgeT987bFhfwSjnESxNSHJ-OWOZ_yxEu8mWmvWYdUH5Y-4EjowJspxOv9b4gkSB0/pub?gid=0&output=csv";
Chart.register(ChartDataLabels);

let database = [];
let myCharts = {};

function parseDate(s) {
    if (!s || typeof s !== 'string') return null;
    s = s.trim();
    if (s.includes('/')) {
        const p = s.split('/');
        if (p.length !== 3) return null;
        const d = new Date(p[2], p[1] - 1, p[0]);
        return isNaN(d) ? null : d;
    }
    if (s.includes('-')) {
        const d = new Date(s);
        return isNaN(d) ? null : d;
    }
    return null;
}

function normalize(str) {
    return String(str || '')
        .replace('#REF!', '')
        .trim()
        .toUpperCase();
}

async function init() {
    const r = await fetch(`${CSV_URL}&t=${Date.now()}`);
    const t = await r.text();
    const raw = Papa.parse(t, { header: true, skipEmptyLines: true }).data;

    database = raw.map(row => {
        const colTransp = Object.keys(row).find(k => k.toUpperCase().includes('TRANSPORT')) || '';
        const colQtd = Object.keys(row).find(k => k.toUpperCase().includes('QUANTIDADE')) || '';
        const colPerfil = Object.keys(row).find(k => k.toUpperCase().includes('PERFIL')) || '';
        const colHub = Object.keys(row).find(k => k.toUpperCase().includes('HUB')) || '';

        const dObj = parseDate(row['DATA']);
        if (!dObj) return null;

        const transp = normalize(row[colTransp]);
        if (!transp || transp === 'N/D') return null;

        return {
            dateStr: row['DATA'],
            dateObj: dObj,
            hub: normalize(row[colHub]) || 'OUTROS',
            transp,
            perfil: normalize(row[colPerfil]),
            qtd: parseInt(String(row[colQtd]).replace(/\D/g, '')) || 0
        };
    }).filter(d => d && d.qtd > 0);

    const dates = database.map(d => d.dateObj);
    const maxD = new Date(Math.max(...dates));
    const minD = new Date(maxD);
    minD.setDate(maxD.getDate() - 7);

    d-start.value = minD.toISOString().split('T')[0];
    d-end.value = maxD.toISOString().split('T')[0];

    fill('f-hub', 'hub');
    fill('f-transp', 'transp');

    render();
    document.querySelectorAll('input, select').forEach(el => el.onchange = render);
}

function fill(id, key) {
    const el = document.getElementById(id);
    [...new Set(database.map(d => d[key]))]
        .sort()
        .forEach(v => el.innerHTML += `<option value="${v}">${v}</option>`);
}

function render() {
    const sV = new Date(d-start.value);
    const eV = new Date(d-end.value);
    const hV = f-hub.value;
    const tV = f-transp.value;

    const f = database.filter(d =>
        d.dateObj >= sV && d.dateObj <= eV &&
        (!hV || d.hub === hV) &&
        (!tV || d.transp === tV)
    );

    if (!f.length) return;

    const trMap = group(f, 'transp');
    const pfAllowed = ['VUC','PASSEIO','MOTO','VAN','FIORINO','VAN/KOMBI','UTILITÃRIO'];
    const pfMap = group(f.filter(x => pfAllowed.includes(x.perfil)), 'perfil');
    const dtMap = group(f, 'dateStr');

    draw('c-bar', 'bar', trMap, { backgroundColor:'#EE4D2D', indexAxis:'y' }, true, 10);
    draw('c-pie', 'doughnut', pfMap, { 
        backgroundColor:['#001529','#EE4D2D','#0EA5E9','#94A3B8','#F59E0B','#10B981','#8B5CF6']
    });
}

function draw(id, type, dataMap, extra, sort=false, limit=0) {
    if (myCharts[id]) myCharts[id].destroy();
    let entries = Object.entries(dataMap);
    if (sort) entries.sort((a,b)=>b[1]-a[1]);
    if (limit) entries = entries.slice(0, limit);

    myCharts[id] = new Chart(document.getElementById(id), {
        type,
        data:{ labels:entries.map(e=>e[0]), datasets:[{ data:entries.map(e=>e[1]), ...extra }]},
        options:{
            responsive:true,
            maintainAspectRatio:false,
            plugins:{
                legend:{
                    display:type==='doughnut',
                    position:'bottom',
                    labels:{ color:'#000', font:{ weight:'bold', size:10 }}
                },
                datalabels:{
                    color:'#000',
                    font:{ weight:'bold', size:10 },
                    formatter:v=>v.toLocaleString('pt-BR')
                }
            }
        }
    });
}

function group(arr,key){
    return arr.reduce((a,c)=>{ a[c[key]]=(a[c[key]]||0)+c.qtd; return a;},{});
}

init();
</script>
