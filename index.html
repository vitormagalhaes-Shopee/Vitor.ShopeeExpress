<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Shopee Express | Ops Intelligence</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
body { font-family: Inter, sans-serif; background:#F7F9FC; }
.card { background:#fff; border-radius:14px; border:1px solid #E5E7EB; box-shadow:0 4px 10px rgba(0,0,0,.04); }
</style>
</head>

<body class="text-gray-800">

<!-- HEADER -->
<header class="bg-white border-b p-4 sticky top-0 z-50">
  <div class="max-w-[1400px] mx-auto flex flex-wrap gap-3 justify-between items-center">
    <h1 class="font-black text-lg">Shopee Express <span class="text-blue-600">| Ops Dashboard</span></h1>

    <!-- FILTROS -->
    <div class="flex flex-wrap gap-2">
      <select id="f-hub" class="border px-3 py-2 rounded text-xs font-bold"></select>
      <select id="f-ciclo" class="border px-3 py-2 rounded text-xs font-bold"></select>
      <select id="f-transp" class="border px-3 py-2 rounded text-xs font-bold"></select>

      <!-- FILTRO DATA (ETAPA 2) -->
      <input type="date" id="f-date-start" class="border px-2 py-2 rounded text-xs font-bold">
      <input type="date" id="f-date-end" class="border px-2 py-2 rounded text-xs font-bold">

      <button onclick="resetFilters()" class="text-xs font-bold text-blue-600">Limpar</button>
    </div>
  </div>
</header>

<main class="max-w-[1400px] mx-auto p-6 space-y-6">

<!-- KPIs (ETAPA 3) -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-4">
  <div class="card p-5 border-l-4 border-blue-600">
    <p class="text-xs text-gray-400 uppercase">Total de Veículos</p>
    <h2 id="kpi-total" class="text-3xl font-black">0</h2>
  </div>

  <div class="card p-5 border-l-4 border-blue-400">
    <p class="text-xs text-gray-400 uppercase">Transportadora Líder</p>
    <h2 id="kpi-transp" class="text-xl font-black">-</h2>
  </div>

  <div class="card p-5 border-l-4 border-blue-300">
    <p class="text-xs text-gray-400 uppercase">Modal Predominante</p>
    <h2 id="kpi-modal" class="text-xl font-black">-</h2>
  </div>

  <div class="card p-5 border-l-4 border-blue-200">
    <p class="text-xs text-gray-400 uppercase">Data Mais Recente</p>
    <h2 id="kpi-date" class="text-xl font-black">-</h2>
  </div>
</div>

<!-- EVOLUÇÃO -->
<div class="card p-6">
  <h3 class="font-bold mb-3">Evolução Diária da Frota (7 dias)</h3>
  <canvas id="chart-evolution" height="80"></canvas>
</div>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

  <div class="card p-6">
    <h3 class="font-bold mb-3">Volume por Perfil de Veículo</h3>
    <canvas id="chart-perfil"></canvas>
  </div>

  <div class="card p-6">
    <h3 class="font-bold mb-3">Quantidade por Transportadora (Top 5)</h3>
    <canvas id="chart-transp"></canvas>
  </div>

  <div class="card p-6">
    <h3 class="font-bold mb-3">Distribuição por Modal</h3>
    <canvas id="chart-modal"></canvas>
  </div>

  <div class="card p-6">
    <h3 class="font-bold mb-3">Volume por Hub</h3>
    <canvas id="chart-hub"></canvas>
  </div>

</div>
</main>

<script>
/* ==============================
 ETAPA 1 — SANITIZAÇÃO DE DADOS
 Remove linhas inválidas (#REF, N/D, vazio)
============================== */

const SHEET =
"https://docs.google.com/spreadsheets/d/e/2PACX-1vT4QgrRy659Pt4wBgeT987bFhfwSjnESxNSHJ-OWOZ_yxEu8mWmvWYdUH5Y-4EjowJspxOv9b4gkSB0/pub?output=csv";

let raw = [], charts={};

function isValid(v){
  return v && v !== '#REF!' && v !== 'N/D';
}

fetch(SHEET)
.then(r=>r.text())
.then(csv=>{
  const data = Papa.parse(csv,{header:true}).data;

  raw = data
    .map(r=>({
      date: r['DATA'],
      ciclo: r['CICLO (AM / DD)'],
      hub: r['HUB'],
      transp: r['TRANSPORTADORA'],
      perfil: r['PERFIL DO VEÍCULO'],
      qtd: Number(r['QUANTIDADE DE VEÍCULOS']) || 0
    }))
    .filter(r =>
      isValid(r.date) &&
      isValid(r.ciclo) &&
      isValid(r.hub) &&
      isValid(r.transp) &&
      isValid(r.perfil)
    );

  initFilters();
  update();
});

/* ==============================
 ETAPA 2 — FILTROS
============================== */
function initFilters(){
  fill('f-hub','hub','TODOS HUBS');
  fill('f-ciclo','ciclo','TODOS CICLOS');
  fill('f-transp','transp','TODAS TRANSP');

  document.querySelectorAll('select,input')
    .forEach(el=>el.onchange=update);
}

function fill(id,key,label){
  const el=document.getElementById(id);
  el.innerHTML=`<option value="">${label}</option>`;
  [...new Set(raw.map(r=>r[key]))]
    .sort().forEach(v=>{
      el.innerHTML+=`<option>${v}</option>`;
    });
}

function resetFilters(){
  document.querySelectorAll('select,input').forEach(e=>e.value="");
  update();
}

function getFiltered(){
  const h=f('f-hub'), c=f('f-ciclo'), t=f('f-transp');
  const d1=f('f-date-start'), d2=f('f-date-end');

  return raw.filter(r=>
    (!h||r.hub===h) &&
    (!c||r.ciclo===c) &&
    (!t||r.transp===t) &&
    (!d1||r.date>=d1) &&
    (!d2||r.date<=d2)
  );
}

const f=id=>document.getElementById(id).value;

/* ==============================
 ETAPA 3 — KPIs
============================== */
function updateKPIs(d){
  const total = d.reduce((a,b)=>a+b.qtd,0);

  const group=(k)=>Object.entries(
    d.reduce((a,b)=>{a[b[k]]=(a[b[k]]||0)+b.qtd;return a;},{}))
    .sort((a,b)=>b[1]-a[1])[0]?.[0]||'-';

  document.getElementById('kpi-total').innerText=total.toLocaleString();
  document.getElementById('kpi-transp').innerText=group('transp');
  document.getElementById('kpi-modal').innerText=group('perfil');
  document.getElementById('kpi-date').innerText=[...new Set(d.map(r=>r.date))].sort().pop();
}

/* ==============================
 ETAPA 4 — GRÁFICOS
============================== */
function update(){
  const d=getFiltered();
  updateKPIs(d);

  renderLine('chart-evolution', last7(d));
  renderBar('chart-perfil', group(d,'perfil',[
    'VUC','PASSEIO','MOTO','VAN','FIORINO','VAN/KOMBI','UTILITÁRIO'
  ]));

  renderBar('chart-transp', topN(d,'transp',5));
  renderDoughnut('chart-modal', group(d,'perfil'));
  renderBar('chart-hub', topN(d,'hub',10));
}

function group(d,k,allow=null){
  return Object.entries(
    d.filter(r=>!allow||allow.includes(r[k]))
     .reduce((a,b)=>{a[b[k]]=(a[b[k]]||0)+b.qtd;return a;},{}));
}

function topN(d,k,n){
  return group(d,k).sort((a,b)=>b[1]-a[1]).slice(0,n);
}

function last7(d){
  const m={};
  d.forEach(r=>m[r.date]=(m[r.date]||0)+r.qtd);
  return Object.entries(m).sort().slice(-7);
}

/* ==============================
 RENDERS (visual executivo, azul)
============================== */
function clear(id){ if(charts[id]) charts[id].destroy(); }

function renderLine(id,data){
  clear(id);
  charts[id]=new Chart(document.getElementById(id),{
    type:'line',
    data:{labels:data.map(x=>x[0]),datasets:[{
      data:data.map(x=>x[1]),
      borderColor:'#2563EB',
      backgroundColor:'rgba(37,99,235,.15)',
      fill:true,tension:.4
    }]},
    options:{plugins:{legend:{display:false}},scales:{x:{grid:{display:false}},y:{grid:{display:false}}}}
  });
}

function renderBar(id,data){
  clear(id);
  charts[id]=new Chart(document.getElementById(id),{
    type:'bar',
    data:{labels:data.map(x=>x[0]),datasets:[{
      data:data.map(x=>x[1]),
      backgroundColor:'#2563EB'
    }]},
    options:{plugins:{legend:{display:false}},scales:{x:{grid:{display:false}},y:{grid:{display:false}}}}
  });
}

function renderDoughnut(id,data){
  clear(id);
  charts[id]=new Chart(document.getElementById(id),{
    type:'doughnut',
    data:{labels:data.map(x=>x[0]),datasets:[{
      data:data.map(x=>x[1]),
      backgroundColor:['#2563EB','#60A5FA','#93C5FD','#BFDBFE']
    }]},
    options:{cutout:'65%'}
  });
}
</script>
</body>
</html>
