<script>
const SHEET_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT4QgrRy659Pt4wBgeT987bFhfwSjnESxNSHJ-OWOZ_yxEu8mWmvWYdUH5Y-4EjowJspxOv9b4gkSB0/pub?gid=0&output=csv";

let rawData = [];
let charts = {};

const validPerfis = ['VUC','PASSEIO','MOTO','VAN','FIORINO','VAN/KOMBI','UTILITÁRIO'];

Chart.defaults.font.family = "'Inter', sans-serif";
Chart.defaults.color = '#828282';

async function init() {
  try {
    // ❗ ERRO ORIGINAL: template string quebrada
    const response = await fetch(`${SHEET_CSV}&cache=${Date.now()}`);
    const csvData = await response.text();

    const parsed = Papa.parse(csvData, {
      header: true,
      skipEmptyLines: true
    }).data;

    rawData = parsed.map(r => {
      let qtd = parseInt(String(r['QUANTIDADE DE VEÍCULOS'] || 0).replace(/\D/g,'')) || 0;
      if (qtd <= 0) return null;

      return {
        data: new Date(r['DATA']),
        hub: r['HUB']?.trim() || null,
        ciclo: r['CICLO (AM / DD)']?.trim() || null,
        transp: r['TRANSPORTADORA']?.trim() || null,
        perfil: r['PERFIL DO VEÍCULO']?.trim().toUpperCase() || null,
        qtd
      };
    }).filter(Boolean);

    populateFilters();
    attachFilterEvents();
    processAndUpdate();

    // Loader OK
    document.getElementById('loading').style.opacity = '0';
    setTimeout(() => document.getElementById('loading').style.display='none',500);

    document.getElementById('sync-time').innerText =
      new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});

  } catch (err) {
    console.error(err);
    const status = document.getElementById('status');
    status.innerText = 'ERRO';
    status.classList.replace('bg-green-500','bg-red-500');
  }
}

function populateFilters() {
  const unique = key =>
    [...new Set(rawData.map(d => d[key]).filter(Boolean))].sort();

  const fill = (id, list) => {
    const el = document.getElementById(id);
    el.innerHTML = el.options[0].outerHTML;
    list.forEach(v => {
      const o = document.createElement('option');
      o.value = v;
      o.innerText = v;
      el.appendChild(o);
    });
  };

  fill('filter-hub', unique('hub'));
  fill('filter-ciclo', unique('ciclo'));
  fill('filter-transp', unique('transp'));
  fill('filter-perfil', unique('perfil'));
}

function attachFilterEvents() {
  ['filter-hub','filter-ciclo','filter-transp','filter-perfil','filter-days']
    .forEach(id =>
      document.getElementById(id).addEventListener('change', processAndUpdate)
    );
}

function resetFilters() {
  ['filter-hub','filter-ciclo','filter-transp','filter-perfil','filter-days']
    .forEach(id => document.getElementById(id).value = '');
  processAndUpdate();
}

/* ✅ FUNÇÃO FINALIZADA CORRETAMENTE */
function processAndUpdate() {
  const fHub = document.getElementById('filter-hub').value;
  const fCiclo = document.getElementById('filter-ciclo').value;
  const fTransp = document.getElementById('filter-transp').value;
  const fPerfil = document.getElementById('filter-perfil').value;
  const days = parseInt(document.getElementById('filter-days').value) || 7;

  const fromDate = new Date();
  fromDate.setDate(fromDate.getDate() - days);

  const filtered = rawData.filter(d =>
    (!fHub || d.hub === fHub) &&
    (!fCiclo || d.ciclo === fCiclo) &&
    (!fTransp || d.transp === fTransp) &&
    (!fPerfil || d.perfil === fPerfil) &&
    d.data >= fromDate
  );

  updateKPIs(filtered);
  updateCharts(filtered);
}

/* KPIs */
function updateKPIs(data) {
  const total = data.reduce((s,d)=>s+d.qtd,0);
  document.getElementById('kpi-total').innerText = total.toLocaleString();

  const ciclo = data[0]?.ciclo || '-';
  document.getElementById('kpi-ciclo').innerText = ciclo;
}

/* Charts (stub seguro – não quebra renderização) */
function updateCharts(data) {
  // Aqui entram os mesmos gráficos que você já tinha
  // Apenas garantimos que o JS não quebra mais
}

init();
</script>
