<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SHOPEE EXPRESS | Logistics Tower V24</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { background-color: #F1F5F9; font-family: 'Inter', sans-serif; color: #000; }
        .dashboard-card { background: white !important; border-radius: 12px; border: 1px solid #E2E8F0; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .shopee-bg { background-color: #EE4D2D; }
        .filter-field { background: #FFF !important; color: #000 !important; border: 2px solid #334155 !important; border-radius: 6px; padding: 6px; font-weight: bold; width: 100%; font-size: 12px; }
        
        /* LEGENDA DOS FILTROS EM BRANCO */
        label { font-weight: 900; font-size: 10px; color: #FFFFFF !important; text-transform: uppercase; margin-bottom: 4px; display: block; letter-spacing: 0.05em; }
    </style>
</head>
<body class="p-0 m-0">

    <header class="bg-[#001529] text-white p-6 border-b-4 border-[#EE4D2D] sticky top-0 z-[100]">
        <div class="max-w-[1600px] mx-auto flex flex-col xl:flex-row justify-between items-center gap-6">
            <div class="flex items-center gap-4">
                <div class="shopee-bg p-2 rounded-lg font-bold italic text-xl">S</div>
                <h1 class="font-black text-2xl italic uppercase text-white leading-none tracking-tighter">SHOPEE <span class="text-[#EE4D2D]">EXPRESS</span></h1>
            </div>
            
            <div class="flex flex-wrap items-end gap-4 bg-slate-800/80 p-4 rounded-xl border border-white/10">
                <div class="w-32"><label>Data In√≠cio</label><input type="date" id="d-start" class="filter-field"></div>
                <div class="w-32"><label>Data Fim</label><input type="date" id="d-end" class="filter-field"></div>
                <div class="w-40"><label>Hub Operacional</label><select id="f-hub" class="filter-field"><option value="">TODOS OS HUBS</option></select></div>
                <div class="w-40"><label>Transportadora</label><select id="f-transp" class="filter-field"><option value="">TODAS AS 3PL</option></select></div>
                <button onclick="location.reload()" class="shopee-bg text-white px-6 py-2 rounded-lg font-black text-xs uppercase shadow-lg hover:brightness-110 active:scale-95 transition-all">RESET</button>
            </div>
        </div>
    </header>

    <main class="max-w-[1600px] mx-auto p-6 grid grid-cols-1 gap-6">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="dashboard-card border-l-8 border-blue-900 text-center"><p class="text-[10px] font-black uppercase text-slate-400">Frota Total Consolidada</p><span id="k-total" class="text-3xl font-black text-blue-900">0</span></div>
            <div class="dashboard-card border-l-8 border-[#EE4D2D] text-center"><p class="text-[10px] font-black uppercase text-slate-400">Parceiro L√≠der</p><span id="k-leader" class="text-lg font-black truncate block text-[#EE4D2D]">--</span></div>
            <div class="dashboard-card border-l-8 border-sky-400 text-center"><p class="text-[10px] font-black uppercase text-slate-400">Perfil Predominante</p><span id="k-perfil" class="text-lg font-black block text-sky-600">--</span></div>
            <div class="dashboard-card border-l-8 border-slate-400 text-center"><p class="text-[10px] font-black uppercase text-slate-400">Refer√™ncia Base</p><span id="k-date" class="text-lg font-black block text-slate-600">--</span></div>
        </div>

        <div class="dashboard-card h-[350px]">
            <h4 class="font-black text-xs text-slate-500 uppercase mb-4 italic flex items-center gap-2">
                <span class="w-2 h-2 bg-blue-900 rounded-full"></span> Evolu√ß√£o Operacional (Volume Di√°rio)
            </h4>
            <div class="h-[280px] w-full"><canvas id="c-line"></canvas></div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="dashboard-card h-[450px]">
                <h4 class="font-black text-xs text-slate-500 uppercase mb-4 italic">üèÜ Top 10 Transportadoras por Volume</h4>
                <div class="h-[380px] w-full"><canvas id="c-bar"></canvas></div>
            </div>
            <div class="dashboard-card h-[450px]">
                <h4 class="font-black text-xs text-slate-500 uppercase mb-4 italic">üìä Mix de Perfis de Ve√≠culos</h4>
                <div class="h-[380px] w-full"><canvas id="c-pie"></canvas></div>
            </div>
        </div>

        <div class="dashboard-card h-[400px]">
            <h4 class="font-black text-xs text-slate-500 uppercase mb-4 italic">üè¢ Performance de Frota por Hub</h4>
            <div class="h-[320px] w-full"><canvas id="c-hub"></canvas></div>
        </div>
    </main>

    <script>
        const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT4QgrRy659Pt4wBgeT987bFhfwSjnESxNSHJ-OWOZ_yxEu8mWmvWYdUH5Y-4EjowJspxOv9b4gkSB0/pub?gid=0&output=csv";
        Chart.register(ChartDataLabels);
        let database = [];
        let myCharts = {};

        async function init() {
            const r = await fetch(`${CSV_URL}&v=${Date.now()}`);
            const t = await r.text();
            const raw = Papa.parse(t, {header:true, skipEmptyLines:true}).data;

            database = raw.map(row => {
                const keys = Object.keys(row);
                const findCol = (terms) => keys.find(k => terms.some(t => k.toUpperCase().includes(t)));
                
                const colT = findCol(['TRANSPORTADORA', '3PL']);
                const colQ = findCol(['QUANTIDADE', 'QTD']);
                const colP = findCol(['PERFIL']);
                const colH = findCol(['HUB']);

                const dateVal = row['DATA'] || '';
                if(!dateVal || dateVal.includes('#VALUE')) return null;

                const pDate = (s) => {
                    const b = s.split('/');
                    return b.length === 3 ? new Date(b[2], b[1]-1, b[0]) : new Date(s);
                };

                return {
                    dateObj: pDate(dateVal),
                    dateStr: dateVal,
                    hub: (row[colH] || 'N/D').trim(),
                    transp: (row[colT] || 'N/D').trim(),
                    perfil: (row[colP] || 'N/D').trim().toUpperCase(),
                    qtd: parseInt(String(row[colQ] || '0').replace(/\D/g,'')) || 0
                };
            }).filter(d => d && d.qtd > 0 && d.transp !== 'N/D');

            const populate = (id, key) => {
                const vals = [...new Set(database.map(d => d[key]))].sort();
                vals.forEach(v => document.getElementById(id).innerHTML += `<option value="${v}">${v}</option>`);
            };
            populate('f-hub', 'hub');
            populate('f-transp', 'transp');

            render();
            document.querySelectorAll('input, select').forEach(el => el.onchange = render);
        }

        function render() {
            const f = database.filter(d => {
                const s = new Date(document.getElementById('d-start').value || '2000-01-01');
                const e = new Date(document.getElementById('d-end').value || '2099-12-31');
                const h = document.getElementById('f-hub').value;
                const t = document.getElementById('f-transp').value;
                return d.dateObj >= s && d.dateObj <= e && (!h || d.hub === h) && (!t || d.transp === t);
            });

            if(!f.length) return;

            const trMap = group(f, 'transp');
            const pfMap = group(f, 'perfil');
            const hbMap = group(f, 'hub');
            const dtMap = group(f, 'dateStr');

            document.getElementById('k-total').innerText = f.reduce((a,b) => a+b.qtd, 0).toLocaleString('pt-BR');
            document.getElementById('k-leader').innerText = Object.entries(trMap).sort((a,b)=>b[1]-a[1])[0]?.[0] || '--';
            document.getElementById('k-perfil').innerText = Object.entries(pfMap).sort((a,b)=>b[1]-a[1])[0]?.[0] || '--';
            document.getElementById('k-date').innerText = f[f.length-1].dateStr;

            // GR√ÅFICO DE LINHA (VOLTOU!)
            drawLine('c-line', dtMap);
            drawBar('c-bar', trMap, '#EE4D2D', true);
            drawPie('c-pie', pfMap);
            drawBar('c-hub', hbMap, '#001529', false);
        }

        function drawLine(id, map) {
            if(myCharts[id]) myCharts[id].destroy();
            const entries = Object.entries(map).sort((a,b) => {
                const p = (s) => { const x=s.split('/'); return new Date(x[2],x[1]-1,x[0]); };
                return p(a[0]) - p(b[0]);
            });
            myCharts[id] = new Chart(document.getElementById(id), {
                type: 'line',
                data: {
                    labels: entries.map(x => x[0]),
                    datasets: [{ label:'Volume', data: entries.map(x => x[1]), borderColor: '#001529', backgroundColor:'rgba(0,21,41,0.1)', fill: true, tension: 0.3 }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false }, datalabels: { align:'top', font:{weight:'bold'} } },
                    scales: { y: { display: false, grace:'15%' }, x: { grid: { display:false } } }
                }
            });
        }

        function drawBar(id, map, color, isHorizontal) {
            if(myCharts[id]) myCharts[id].destroy();
            const entries = Object.entries(map).sort((a,b) => b[1]-a[1]).slice(0, 10);
            myCharts[id] = new Chart(document.getElementById(id), {
                type: 'bar',
                data: {
                    labels: entries.map(x => x[0]),
                    datasets: [{ data: entries.map(x => x[1]), backgroundColor: color, borderRadius: 5 }]
                },
                options: {
                    indexAxis: isHorizontal ? 'y' : 'x',
                    responsive: true, maintainAspectRatio: false,
                    plugins: { 
                        legend: { display: false },
                        datalabels: { color: '#000', font: { weight: 'bold' }, anchor: 'end', align: isHorizontal ? 'right' : 'top' }
                    },
                    scales: { x: { display: !isHorizontal, grid:{display:false} }, y: { display: isHorizontal, grid:{display:false} } }
                }
            });
        }

        function drawPie(id, map) {
            if(myCharts[id]) myCharts[id].destroy();
            const entries = Object.entries(map).sort((a,b) => b[1]-a[1]);
            myCharts[id] = new Chart(document.getElementById(id), {
                type: 'doughnut',
                data: {
                    labels: entries.map(x => x[0]),
                    datasets: [{ data: entries.map(x => x[1]), backgroundColor: ['#001529','#EE4D2D','#0EA5E9','#64748B','#F59E0B','#10B981'] }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    layout: { padding: { right: 120, left: 20 } },
                    plugins: {
                        legend: { position: 'right', labels: { boxWidth: 12, font: { size: 10, weight: 'bold' } } },
                        datalabels: { display: false }
                    }
                }
            });
        }

        function group(arr, key) { return arr.reduce((acc, c) => { acc[c[key]] = (acc[c[key]] || 0) + c.qtd; return acc; }, {}); }
        init();
    </script>
</body>
</html>
