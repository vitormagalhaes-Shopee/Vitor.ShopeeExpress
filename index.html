<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Shopee Express | Logistics Intelligence Ops</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
body { background-color:#F8F9FA;font-family:'Inter',sans-serif;color:#2D2D2D }
.shopee-orange{color:#EE4D2D}.bg-shopee{background-color:#EE4D2D}
.card-header{border-bottom:1px solid #F0F0F0;padding-bottom:12px;margin-bottom:16px}
.dashboard-card{background:white;border-radius:12px;box-shadow:0 4px 6px -1px rgba(0,0,0,.05),0 2px 4px -1px rgba(0,0,0,.03);border:1px solid #E5E7EB}
.loader{border-top-color:#EE4D2D;animation:spin 1s linear infinite}
@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
</style>
</head>
<body>

<div id="loading" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-white">
<div class="loader rounded-full border-8 border-gray-100 h-20 w-20 mb-4"></div>
</div>

<!-- (HTML visual mantido integralmente – omitido aqui por limite de espaço, idêntico ao enviado) -->

<script>
const SHEET_CSV="https://docs.google.com/spreadsheets/d/e/2PACX-1vT4QgrRy659Pt4wBgeT987bFhfwSjnESxNSHJ-OWOZ_yxEu8mWmvWYdUH5Y-4EjowJspxOv9b4gkSB0/pub?gid=0&output=csv";
let rawData=[],charts={};

function normalizeText(v){return String(v||'').trim().toUpperCase()}
function normalizePerfil(v){const t=normalizeText(v);return t&&t!=='N/D'?t:null}
function parseDateSafe(v){
if(!v)return null;
const p=String(v).split(/[\/\-]/);
if(p.length<3)return null;
const d=new Date(p.reverse().join('-'));
return isNaN(d)?null:d.getTime()
}
function mapColumn(row,keys){
const k=Object.keys(row).find(h=>keys.some(x=>h.toUpperCase().includes(x)));
return k?row[k]:null
}

async function safeInit(){
const loader=document.getElementById('loading');
try{
const r=await fetch(`${SHEET_CSV}&c=${Date.now()}`);
const t=await r.text();
const parsed=Papa.parse(t,{header:true,skipEmptyLines:true}).data;

rawData=parsed.map(r=>{
const ts=parseDateSafe(mapColumn(r,['DATA']));
if(!ts)return null;
return{
ts,
data:ts,
hub:normalizeText(mapColumn(r,['HUB'])),
ciclo:normalizeText(mapColumn(r,['CICLO'])),
transp:normalizeText(mapColumn(r,['TRANSP'])),
perfil:normalizePerfil(mapColumn(r,['PERFIL'])),
qtd:parseInt(String(mapColumn(r,['QUANT'])).replace(/\D/g,''))||0
}
}).filter(Boolean);

populateFilters();
attachFilterEvents();
processAndUpdate();
}catch(e){
console.error(e);
rawData=[];
populateFilters();
processAndUpdate();
}finally{
loader.remove();
}
}

function populateFilters(){
const uniq=(k)=>[...new Set(rawData.map(d=>d[k]).filter(Boolean))].sort();
[['filter-hub','hub'],['filter-ciclo','ciclo'],['filter-transp','transp'],['filter-perfil','perfil']]
.forEach(([id,k])=>{
const el=document.getElementById(id);
el.innerHTML='<option value="">TODOS</option>';
uniq(k).forEach(v=>{
const o=document.createElement('option');o.value=v;o.textContent=v;el.appendChild(o)
})
})
}

function attachFilterEvents(){
['filter-hub','filter-ciclo','filter-transp','filter-perfil']
.forEach(id=>document.getElementById(id).onchange=processAndUpdate)
}

function processAndUpdate(){
const f={
hub:filter-hub.value,
ciclo:filter-ciclo.value,
transp:filter-transp.value,
perfil:filter-perfil.value
};
let data=rawData.filter(d=>
(!f.hub||d.hub===f.hub)&&(!f.ciclo||d.ciclo===f.ciclo)&&(!f.transp||d.transp===f.transp)&&(!f.perfil||d.perfil===f.perfil)
);
if(!data.length)data=rawData;
updateKPIs(data);
updateCharts(data);
}

function updateKPIs(d){
document.getElementById('kpi-total').textContent=d.reduce((a,b)=>a+b.qtd,0);
document.getElementById('kpi-hubs').textContent=new Set(d.map(x=>x.hub)).size;
}

function emptyChart(id,text){
if(charts[id])charts[id].destroy();
const ctx=document.getElementById(id).getContext('2d');
ctx.clearRect(0,0,300,150);
ctx.fillStyle='#999';ctx.fillText(text||'Sem dados',20,50);
}

function updateCharts(d){
if(!d.length){
['chart-evolution','chart-perfil','chart-transp','chart-hubs','chart-ciclo-hub']
.forEach(id=>emptyChart(id));
return;
}
const byDate={};
d.forEach(x=>byDate[x.ts]=(byDate[x.ts]||0)+x.qtd);
const dates=Object.keys(byDate).map(Number).sort((a,b)=>a-b);
renderLineChart('chart-evolution',dates.map(t=>new Date(t).toLocaleDateString()),dates.map(t=>byDate[t]));
}

safeInit();
setInterval(safeInit,300000);
</script>
</body>
</html>
