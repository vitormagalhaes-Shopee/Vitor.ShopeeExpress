<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Logistics Dashboard | Shopee</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { background-color: #f5f5f5; font-family: 'Roboto', sans-serif; }
        .shopee-orange { color: #EE4D2D; }
        .bg-shopee { background-color: #EE4D2D; }
        .card { background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .loader { border-top-color: #EE4D2D; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loading" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-white">
        <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mb-4"></div>
        <h2 class="text-xl font-semibold text-gray-700 uppercase tracking-widest">Sincronizando Shopee Express...</h2>
        <p class="text-sm text-gray-400 mt-2">Se demorar, verifique se a planilha está pública.</p>
    </div>

    <header class="bg-white border-b p-4 sticky top-0 z-40">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-2">
                <div class="bg-shopee p-2 rounded text-white"><i data-lucide="truck"></i></div>
                <h1 class="font-bold text-xl uppercase tracking-tighter italic">Shopee <span class="shopee-orange">Logistics</span></h1>
            </div>
            <div id="lastSync" class="text-xs text-gray-400 font-mono">Aguardando dados...</div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto p-4">
        <div class="card p-4 mb-6 grid grid-cols-1 md:grid-cols-4 gap-4">
            <select id="fReg" class="border p-2 rounded text-sm outline-none"><option value="">Região: Todas</option></select>
            <select id="fHub" class="border p-2 rounded text-sm outline-none"><option value="">Hub: Todos</option></select>
            <select id="fTransp" class="border p-2 rounded text-sm outline-none"><option value="">Transportadora: Todas</option></select>
            <button onclick="window.location.reload()" class="bg-orange-50 text-[#EE4D2D] font-bold py-2 rounded text-sm hover:bg-orange-100 transition-all flex items-center justify-center gap-2">
                <i data-lucide="refresh-cw" class="w-4 h-4"></i> Forçar Atualização
            </button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="card p-5 border-l-4 border-[#EE4D2D]">
                <p class="text-[10px] font-bold text-gray-400 uppercase">Total Veículos</p>
                <h3 id="kpi1" class="text-3xl font-black text-gray-800">0</h3>
            </div>
            <div class="card p-5 border-l-4 border-blue-500">
                <p class="text-[10px] font-bold text-gray-400 uppercase">Hubs Ativos</p>
                <h3 id="kpi2" class="text-3xl font-black text-gray-800">0</h3>
            </div>
            <div class="card p-5 border-l-4 border-green-500">
                <p class="text-[10px] font-bold text-gray-400 uppercase">Transportadora Top</p>
                <h3 id="kpi3" class="text-lg font-bold text-gray-800 truncate">---</h3>
            </div>
            <div class="card p-5 border-l-4 border-purple-500">
                <p class="text-[10px] font-bold text-gray-400 uppercase">Status</p>
                <h3 id="kpi4" class="text-lg font-bold text-green-500 uppercase italic">Online</h3>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="card p-5">
                <h4 class="text-xs font-bold text-gray-400 mb-4 uppercase">Frota por Perfil</h4>
                <div class="h-64"><canvas id="ch1"></canvas></div>
            </div>
            <div class="card p-5">
                <h4 class="text-xs font-bold text-gray-400 mb-4 uppercase">Market Share</h4>
                <div class="h-64"><canvas id="ch2"></canvas></div>
            </div>
        </div>
    </main>

    <script>
        // Substitua APENAS o ID da planilha se necessário
        const SHEET_ID = '1vT4QgrRy659Pt4wBgeT987bFhfwSjnESxNSHJ-OWOZ_yxEu8mWmvWYdUH5Y-4EjowJspxOv9b4gkSB0';
        
        // Links formatados para CSV
        const URL_3PL = `https://docs.google.com/spreadsheets/d/e/${SHEET_ID}/pub?gid=0&output=csv`;
        const URL_HUBS = `https://docs.google.com/spreadsheets/d/e/${SHEET_ID}/pub?gid=2040523267&output=csv`;

        let db = [];
        let hMap = {};
        let myCharts = {};

        async function loadData() {
            try {
                const [r1, r2] = await Promise.all([
                    fetch(URL_3PL).then(r => r.text()),
                    fetch(URL_HUBS).then(r => r.text())
                ]);

                if (r1.includes("HTML") || r1.length < 100) throw new Error("Acesso negado ou link inválido");

                const hubData = Papa.parse(r2, { header: true }).data;
                hubData.forEach(h => { hMap[h.HUB] = h.REGIÃO || h.REGIAO || 'N/A'; });

                const raw = Papa.parse(r1, { header: true, skipEmptyLines: true }).data;
                db = raw.map(row => ({
                    ...row,
                    qtd: parseInt(String(row['QUANTIDADE DE VEÍCULOS'] || 0).replace(/\D/g, '') || 0),
                    reg: hMap[row.HUB] || 'Outros'
                }));

                buildFilters();
                update();
                document.getElementById('loading').style.display = 'none';
                document.getElementById('lastSync').innerText = 'Sincronizado: ' + new Date().toLocaleTimeString();
            } catch (err) {
                console.error(err);
                alert("ERRO DE ACESSO: Verifique se a planilha está 'Publicada na Web' como CSV e se o acesso está livre para 'Qualquer Pessoa'.");
            }
        }

        function update() {
            const f1 = document.getElementById('fReg').value;
            const f2 = document.getElementById('fHub').value;
            const f3 = document.getElementById('fTransp').value;

            const filtered = db.filter(d => 
                (!f1 || d.reg === f1) &&
                (!f2 || d.HUB === f2) &&
                (!f3 || d.TRANSPORTADORA === f3)
            );

            // KPIs
            document.getElementById('kpi1').innerText = filtered.reduce((a, b) => a + b.qtd, 0).toLocaleString();
            document.getElementById('kpi2').innerText = new Set(filtered.map(d => d.HUB)).size;
            
            // Gráficos
            const grp = (arr, key) => arr.reduce((acc, d)
