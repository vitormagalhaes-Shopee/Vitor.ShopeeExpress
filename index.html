<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Shopee Express | Logistics Intelligence Ops</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
body { font-family: 'Inter', sans-serif; background:#F8F9FA }
</style>
</head>

<body>

<div id="loading" class="fixed inset-0 z-50 flex items-center justify-center bg-white">
  <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-orange-500"></div>
</div>

<main class="max-w-[1400px] mx-auto p-6">

  <!-- KPIs -->
  <div class="grid grid-cols-3 gap-4 mb-6">
    <div class="bg-white p-4 rounded shadow">
      <p class="text-xs text-gray-400 font-bold uppercase">Frota Total</p>
      <h2 id="kpi-total" class="text-3xl font-black">0</h2>
    </div>
    <div class="bg-white p-4 rounded shadow">
      <p class="text-xs text-gray-400 font-bold uppercase">Ciclo Predominante</p>
      <h2 id="kpi-ciclo" class="text-3xl font-black">-</h2>
    </div>
    <div class="bg-white p-4 rounded shadow">
      <p class="text-xs text-gray-400 font-bold uppercase">Última Sync</p>
      <h2 id="sync-time" class="text-3xl font-black">--:--</h2>
    </div>
  </div>

  <!-- Gráficos -->
  <div class="grid grid-cols-2 gap-6">
    <div class="bg-white p-4 rounded shadow h-72">
      <canvas id="chart-evolution"></canvas>
    </div>
    <div class="bg-white p-4 rounded shadow h-72">
      <canvas id="chart-perfil"></canvas>
    </div>
  </div>

</main>

<script>
const SHEET_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT4QgrRy659Pt4wBgeT987bFhfwSjnESxNSHJ-OWOZ_yxEu8mWmvWYdUH5Y-4EjowJspxOv9b4gkSB0/pub?gid=0&output=csv";

let rawData = [];
let charts = {};

function normalizeDate(value) {
  if (!value) return null;

  if (!isNaN(value)) {
    const base = new Date(1899, 11, 30);
    return new Date(base.getTime() + value * 86400000);
  }

  value = String(value).split(' ')[0];

  if (value.includes('/')) {
    const [d, m, y] = value.split('/');
    return new Date(`${y}-${m}-${d}`);
  }

  const d = new Date(value);
  return isNaN(d) ? null : d;
}

async function init() {
  const res = await fetch(SHEET_CSV + "&cache=" + Date.now());
  const csv = await res.text();
  const parsed = Papa.parse(csv, { header:true, skipEmptyLines:true }).data;

  rawData = parsed.map(r => ({
    data: normalizeDate(r['DATA']),
    ciclo: String(r['CICLO (AM / DD)'] || '').toUpperCase(),
    perfil: String(r['PERFIL DO VEÍCULO'] || '').toUpperCase(),
    qtd: Number(String(r['QUANTIDADE DE VEÍCULOS'] || '0').replace(/\D/g,'')) || 0
  })).filter(d => d.data && d.qtd > 0);

  updateKPIs(rawData);
  updateCharts(rawData);

  document.getElementById('loading').style.display = 'none';
  document.getElementById('sync-time').innerText =
    new Date().toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'});
}

function updateKPIs(data) {
  const total = data.reduce((a,b)=>a+b.qtd,0);
  const ciclos = {};
  data.forEach(d => ciclos[d.ciclo]=(ciclos[d.ciclo]||0)+d.qtd);

  const top = Object.entries(ciclos).sort((a,b)=>b[1]-a[1])[0]?.[0] || '-';

  document.getElementById('kpi-total').innerText = total.toLocaleString('pt-BR');
  document.getElementById('kpi-ciclo').innerText = top;
}

function updateCharts(data) {
  const dateMap = {};
  data.forEach(d=>{
    const k = d.data.toISOString().slice(0,10);
    dateMap[k]=(dateMap[k]||0)+d.qtd;
  });

  const dates = Object.keys(dateMap).slice(-7);
  const values = dates.map(d=>dateMap[d]);

  renderLine('chart-evolution', dates, values);

  const perfilMap = {};
  data.forEach(d=>perfilMap[d.perfil]=(perfilMap[d.perfil]||0)+d.qtd);

  renderBar('chart-perfil', Object.keys(perfilMap), Object.values(perfilMap));
}

function renderLine(id, labels, values){
  if(charts[id]) charts[id].destroy();
  charts[id]=new Chart(document.getElementById(id),{
    type:'line',
    data:{labels,datasets:[{data:values,borderColor:'#EE4D2D',fill:false}]},
    options:{responsive:true,maintainAspectRatio:false}
  });
}

function renderBar(id, labels, values){
  if(charts[id]) charts[id].destroy();
  charts[id]=new Chart(document.getElementById(id),{
    type:'bar',
    data:{labels,datasets:[{data:values,backgroundColor:'#2563EB'}]},
    options:{responsive:true,maintainAspectRatio:false}
  });
}

init();
</script>

</body>
</html>
