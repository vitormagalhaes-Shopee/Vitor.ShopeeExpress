<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Shopee Express | Premium Dashboard</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- PapaParse -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');

        body {
            background-color: #F0F2F5;
            font-family: 'Inter', sans-serif;
        }

        .shopee-orange { color: #EE4D2D; }
        .bg-shopee { background-color: #EE4D2D; }

        .dashboard-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05);
            transition: transform .2s;
        }
        .dashboard-card:hover { transform: translateY(-4px); }

        .card-header {
            border-bottom: 1px solid #eee;
            padding-bottom: 12px;
            margin-bottom: 20px;
        }

        .loader {
            border-top-color: #EE4D2D;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        select {
            border-radius: 10px;
            border: 1px solid #E0E0E0;
            padding: 8px 12px;
            font-size: 14px;
        }
    </style>
</head>
<body>

<!-- LOADER -->
<div id="loading" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-white">
    <div class="loader rounded-full border-8 border-gray-100 h-24 w-24 mb-4"></div>
    <h2 class="text-2xl font-black text-gray-800 tracking-tighter italic">
        SHOPEE <span class="shopee-orange">EXPRESS</span>
    </h2>
    <p class="text-gray-400 animate-pulse">Otimizando sua frota...</p>
</div>

<!-- HEADER -->
<header class="bg-white shadow-sm p-4 sticky top-0 z-40">
    <div class="max-w-7xl mx-auto flex justify-between items-center">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-shopee rounded-lg flex items-center justify-center text-white shadow-lg">
                üöö
            </div>
            <h1 class="font-black text-2xl uppercase italic tracking-tighter">
                SHOPEE <span class="shopee-orange">EXPRESS</span>
            </h1>
        </div>
        <div id="status" class="text-xs font-bold text-white bg-green-500 px-4 py-2 rounded-full">
            ONLINE
        </div>
    </div>
</header>

<main class="max-w-7xl mx-auto p-6 md:p-10">

    <!-- FILTROS -->
    <div class="dashboard-card p-6 mb-10 grid grid-cols-1 md:grid-cols-4 gap-4">
        <select id="filtro-hub"></select>
        <select id="filtro-ciclo"></select>
        <select id="filtro-transp"></select>
        <select id="filtro-perfil"></select>
    </div>

    <!-- KPIs -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-10">
        <div class="dashboard-card p-8 border-b-8 border-[#EE4D2D]">
            <p class="text-sm font-bold text-gray-400 uppercase">Frota Consolidada</p>
            <h3 id="kpi-total" class="text-5xl font-black text-gray-800">0</h3>
        </div>
        <div class="dashboard-card p-8 border-b-8 border-gray-700">
            <p class="text-sm font-bold text-gray-400 uppercase">Hubs Ativos</p>
            <h3 id="kpi-hubs" class="text-5xl font-black text-gray-800">0</h3>
        </div>
        <div class="dashboard-card p-8 border-b-8 border-gray-400">
            <p class="text-sm font-bold text-gray-400 uppercase">Sincroniza√ß√£o</p>
            <h3 id="sync-time" class="text-2xl font-black italic">--:--</h3>
        </div>
    </div>

    <!-- GR√ÅFICOS -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-10 mb-10">
        <div class="dashboard-card p-8">
            <div class="card-header font-black italic">Perfil do Ve√≠culo</div>
            <div class="h-80"><canvas id="chart-perfil"></canvas></div>
        </div>
        <div class="dashboard-card p-8">
            <div class="card-header font-black italic">Transportadoras</div>
            <div class="h-80"><canvas id="chart-transp"></canvas></div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-10">
        <div class="dashboard-card p-8">
            <div class="card-header font-black italic">Evolu√ß√£o Di√°ria</div>
            <div class="h-64"><canvas id="chart-line"></canvas></div>
        </div>
        <div class="dashboard-card p-8">
            <div class="card-header font-black italic">Volume por HUB</div>
            <div class="h-64"><canvas id="chart-hub"></canvas></div>
        </div>
        <div class="dashboard-card p-8">
            <div class="card-header font-black italic">HUB x Ciclo</div>
            <div class="h-64"><canvas id="chart-stack"></canvas></div>
        </div>
    </div>

</main>

<script>
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT4QgrRy659Pt4wBgeT987bFhfwSjnESxNSHJ-OWOZ_yxEu8mWmvWYdUH5Y-4EjowJspxOv9b4gkSB0/pub?gid=0&output=csv";

let rawData = [];
let charts = {};

function fetchData() {
    Papa.parse(CSV_URL + "&cache=" + Date.now(), {
        download: true,
        header: true,
        complete: res => {
            rawData = res.data.map(r => ({
                data: r.DATA,
                ciclo: r.CICLO,
                hub: r.HUB,
                transp: r.TRANSPORTADORA,
                perfil: r['PERFIL DO VE√çCULO'],
                qtd: Number(r['QUANTIDADE DE VE√çCULOS']) || 0
            }));
            initFilters();
            applyFilters();
            document.getElementById('loading').style.display = 'none';
            document.getElementById('sync-time').innerText =
                new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
        }
    });
}

function initFilters() {
    createFilter('filtro-hub','hub');
    createFilter('filtro-ciclo','ciclo');
    createFilter('filtro-transp','transp');
    createFilter('filtro-perfil','perfil');
}

function createFilter(id,key) {
    const el = document.getElementById(id);
    const values = [...new Set(rawData.map(d => d[key]).filter(Boolean))];
    el.innerHTML = `<option value="">Todos</option>` +
        values.map(v => `<option>${v}</option>`).join('');
    el.onchange = applyFilters;
}

function applyFilters() {
    let data = rawData.filter(d =>
        (!filtroHub.value || d.hub === filtroHub.value) &&
        (!filtroCiclo.value || d.ciclo === filtroCiclo.value) &&
        (!filtroTransp.value || d.transp === filtroTransp.value) &&
        (!filtroPerfil.value || d.perfil === filtroPerfil.value)
    );
    updateKPIs(data);
    renderCharts(data);
}

const filtroHub = document.getElementById('filtro-hub');
const filtroCiclo = document.getElementById('filtro-ciclo');
const filtroTransp = document.getElementById('filtro-transp');
const filtroPerfil = document.getElementById('filtro-perfil');

function updateKPIs(data){
    kpi-total.innerText = data.reduce((a,b)=>a+b.qtd,0).toLocaleString();
    kpi-hubs.innerText = new Set(data.map(d=>d.hub)).size;
}

function group(data,key){
    return data.reduce((acc,d)=>{
        acc[d[key]] = (acc[d[key]]||0)+d.qtd;
        return acc;
    },{});
}

function renderCharts(data){
    Object.values(charts).forEach(c=>c.destroy());
    charts = {};

    const perfil = group(data,'perfil');
    const transp = group(data,'transp');
    const hub = group(data,'hub');

    charts.perfil = new Chart(chartPerfil,{
        type:'bar',
        data:{
            labels:Object.keys(perfil),
            datasets:[{data:Object.values(perfil),backgroundColor:'#EE4D2D',borderRadius:8}]
        },
        options:{indexAxis:'y',plugins:{legend:{display:false}}}
    });

    charts.transp = new Chart(chartTransp,{
        type:'doughnut',
        data:{
            labels:Object.keys(transp),
            datasets:[{data:Object.values(transp),backgroundColor:[
                '#EE4D2D','#2D2D2D','#828282','#E0E0E0'
            ]}]
        }
    });

    charts.hub = new Chart(chartHub,{
        type:'bar',
        data:{labels:Object.keys(hub),datasets:[{data:Object.values(hub),backgroundColor:'#EE4D2D'}]}
    });

    const daily = group(data,'data');
    charts.line = new Chart(chartLine,{
        type:'line',
        data:{labels:Object.keys(daily),datasets:[{data:Object.values(daily),borderColor:'#EE4D2D',tension:.4}]}
    });

    const stack = {};
    data.forEach(d=>{
        stack[d.hub] ??= {AM:0,DD:0};
        stack[d.hub][d.ciclo] += d.qtd;
    });

    charts.stack = new Chart(chartStack,{
        type:'bar',
        data:{
            labels:Object.keys(stack),
            datasets:[
                {label:'AM',data:Object.values(stack).map(v=>v.AM),backgroundColor:'#EE4D2D'},
                {label:'DD',data:Object.values(stack).map(v=>v.DD),backgroundColor:'#828282'}
            ]
        },
        options:{scales:{x:{stacked:true},y:{stacked:true}}}
    });
}

fetchData();
setInterval(fetchData,300000);
</script>
</body>
</html>
