<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopee Express | Logistics Intelligence Ops</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
        body { background-color: #F8F9FA; font-family: 'Inter', sans-serif; color: #2D2D2D; }
        .shopee-orange { color: #EE4D2D; }
        .bg-shopee { background-color: #EE4D2D; }
        .card-header { border-bottom: 1px solid #F0F0F0; padding-bottom: 12px; margin-bottom: 16px; }
        .dashboard-card { 
            background: white; 
            border-radius: 12px; 
            box-shadow: 0 4px 6px -1px rgba(0,0,0,.05),0 2px 4px -1px rgba(0,0,0,.03);
            transition: all .3s cubic-bezier(.4,0,.2,1);
            border: 1px solid #E5E7EB;
        }
        .dashboard-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0,0,0,.08); }
        .loader { border-top-color:#EE4D2D; animation: spin 1s linear infinite; }
        @keyframes spin { 0%{transform:rotate(0deg)}100%{transform:rotate(360deg)} }
    </style>
</head>

<body>
<div id="loading" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-white">
    <div class="loader rounded-full border-8 border-gray-100 h-20 w-20 mb-4"></div>
    <h2 class="text-xl font-black italic uppercase">SHOPEE <span class="shopee-orange">EXPRESS</span></h2>
</div>

<header class="bg-white border-b border-gray-200 p-4 sticky top-0 z-40">
    <div class="max-w-[1400px] mx-auto flex justify-between items-center">
        <h1 class="font-black italic tracking-tight">LOGISTICS INTELLIGENCE</h1>
        <div class="flex gap-2">
            <select id="filter-hub" class="text-xs font-bold bg-white border px-3 py-2 rounded-lg"><option value="">HUB</option></select>
            <select id="filter-ciclo" class="text-xs font-bold bg-white border px-3 py-2 rounded-lg"><option value="">CICLO</option></select>
            <select id="filter-transp" class="text-xs font-bold bg-white border px-3 py-2 rounded-lg"><option value="">TRANSPORTADORA</option></select>
            <select id="filter-perfil" class="text-xs font-bold bg-white border px-3 py-2 rounded-lg"><option value="">PERFIL</option></select>
        </div>
    </div>
</header>

<main class="max-w-[1400px] mx-auto p-6">
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <div class="dashboard-card p-5 border-l-4 border-[#EE4D2D]">
            <p class="text-[10px] font-bold text-gray-400 uppercase">Frota Total</p>
            <h3 id="kpi-total" class="text-3xl font-black">0</h3>
        </div>
        <div class="dashboard-card p-5 border-l-4 border-blue-500">
            <p class="text-[10px] font-bold text-gray-400 uppercase">Veículos por Transportadora</p>
            <h3 id="kpi-transp" class="text-3xl font-black">0</h3>
        </div>
        <div class="dashboard-card p-5 border-l-4 border-indigo-500">
            <p class="text-[10px] font-bold text-gray-400 uppercase">Veículos por Modal</p>
            <h3 id="kpi-modal" class="text-3xl font-black">0</h3>
        </div>
        <div class="dashboard-card p-5 border-l-4 border-gray-300">
            <p class="text-[10px] font-bold text-gray-400 uppercase">Última Sync</p>
            <h3 id="sync-time" class="text-xl font-black text-gray-500">--:--</h3>
        </div>
    </div>

    <div class="dashboard-card p-6 mb-6">
        <div class="flex justify-between items-center mb-4">
            <h4 class="font-black italic uppercase text-sm">Evolução Diária (Últimos Dias)</h4>
            <select id="filter-days" class="text-xs font-bold border rounded px-2 py-1">
                <option value="7">7 dias</option>
                <option value="14">14 dias</option>
                <option value="30">30 dias</option>
            </select>
        </div>
        <div class="text-sm font-bold mb-2">Total no período: <span id="total-periodo">0</span></div>
        <div class="h-64"><canvas id="chart-evolution"></canvas></div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="dashboard-card p-6">
            <h4 class="font-black italic uppercase text-sm mb-4">Perfil de Veículo</h4>
            <div class="h-72"><canvas id="chart-perfil"></canvas></div>
        </div>
        <div class="dashboard-card p-6">
            <h4 class="font-black italic uppercase text-sm mb-4">Market Share Parceiros</h4>
            <div class="h-72"><canvas id="chart-transp"></canvas></div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
        <div class="dashboard-card p-6">
            <h4 class="font-black italic uppercase text-sm mb-4">Volume por Hub</h4>
            <div class="h-72"><canvas id="chart-hubs"></canvas></div>
        </div>
        <div class="dashboard-card p-6">
            <h4 class="font-black italic uppercase text-sm mb-4">Distribuição AM vs DD</h4>
            <div class="h-72"><canvas id="chart-ciclo-hub"></canvas></div>
        </div>
    </div>
</main>

<script>
const SHEET_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT4QgrRy659Pt4wBgeT987bFhfwSjnESxNSHJ-OWOZ_yxEu8mWmvWYdUH5Y-4EjowJspxOv9b4gkSB0/pub?gid=0&output=csv";
let rawData=[],charts={};

const PERFIS_VALIDOS=["VUC","PASSEIO","MOTO","VAN","FIORINO","VAN/KOMBI","UTILITÁRIO"];

function normalizeDate(v){
    if(!v) return null;
    if(!isNaN(v)) return new Date((v-25569)*86400*1000);
    if(v.includes("/")){let[d,m,y]=v.split("/");return new Date(`${y}-${m}-${d}`)}
    return new Date(v);
}

function cleanText(v){
    return String(v||"").trim().toUpperCase();
}

async function init(){
    const csv=await fetch(SHEET_CSV+"&t="+Date.now()).then(r=>r.text());
    const data=Papa.parse(csv,{header:true,skipEmptyLines:true}).data;
    rawData=data.map(r=>{
        const transp=cleanText(r["TRANSPORTADORA"]);
        const perfil=cleanText(r["PERFIL DO VEÍCULO"]);
        return{
            date:normalizeDate(r["DATA"]),
            hub:cleanText(r["HUB"]),
            ciclo:cleanText(r["CICLO (AM / DD)"]),
            transp:(!transp||transp==="ND"||transp==="#REF!")?null:transp,
            perfil:PERFIS_VALIDOS.includes(perfil)?perfil:null,
            qtd:parseInt(String(r["QUANTIDADE DE VEÍCULOS"]||0).replace(/\D/g,""))||0
        }
    }).filter(d=>d.date&&d.qtd>0);

    populateFilters();
    update();
    document.getElementById("loading").style.display="none";
    document.getElementById("sync-time").innerText=new Date().toLocaleTimeString();
}

function populateFilters(){
    ["hub","ciclo","transp","perfil"].forEach(k=>{
        const el=document.getElementById("filter-"+k);
        [...new Set(rawData.map(d=>d[k]).filter(Boolean))].forEach(v=>{
            el.innerHTML+=`<option value="${v}">${v}</option>`
        })
        el.onchange=update;
    });
    document.getElementById("filter-days").onchange=update;
}

function update(){
    let d=[...rawData];
    ["hub","ciclo","transp","perfil"].forEach(k=>{
        const v=document.getElementById("filter-"+k).value;
        if(v) d=d.filter(x=>x[k]===v);
    });

    const days=parseInt(document.getElementById("filter-days").value);
    const maxDate=new Date(Math.max(...d.map(x=>x.date)));
    const min=new Date(maxDate);min.setDate(min.getDate()-days+1);
    d=d.filter(x=>x.date>=min);

    updateKPIs(d);
    updateCharts(d);
}

function updateKPIs(d){
    const total=d.reduce((a,b)=>a+b.qtd,0);
    document.getElementById("kpi-total").innerText=total.toLocaleString("pt-BR");
    document.getElementById("total-periodo").innerText=total.toLocaleString("pt-BR");

    const byTransp={};d.forEach(x=>byTransp[x.transp]=(byTransp[x.transp]||0)+x.qtd);
    document.getElementById("kpi-transp").innerText=Object.values(byTransp).reduce((a,b)=>a+b,0).toLocaleString("pt-BR");

    const byPerfil={};d.forEach(x=>byPerfil[x.perfil]=(byPerfil[x.perfil]||0)+x.qtd);
    document.getElementById("kpi-modal").innerText=Object.values(byPerfil).reduce((a,b)=>a+b,0).toLocaleString("pt-BR");
}

function render(id,type,data,options){
    if(charts[id]) charts[id].destroy();
    charts[id]=new Chart(document.getElementById(id),{type,data,options});
}

function updateCharts(d){
    const dateMap={};d.forEach(x=>{const k=x.date.toLocaleDateString();dateMap[k]=(dateMap[k]||0)+x.qtd});
    render("chart-evolution","line",{labels:Object.keys(dateMap),datasets:[{data:Object.values(dateMap),borderColor:"#EE4D2D",fill:false,tension:.4}]},{plugins:{legend:{display:false}},scales:{x:{grid:{display:false}},y:{grid:{display:false}}}});

    const perfilMap={};d.forEach(x=>x.perfil&&(perfilMap[x.perfil]=(perfilMap[x.perfil]||0)+x.qtd));
    render("chart-perfil","bar",{labels:Object.keys(perfilMap),datasets:[{data:Object.values(perfilMap),backgroundColor:"#3B82F6"}]},{plugins:{legend:{display:false}}});

    const transpMap={};d.forEach(x=>x.transp&&(transpMap[x.transp]=(transpMap[x.transp]||0)+x.qtd));
    const sorted=Object.entries(transpMap).sort((a,b)=>b[1]-a[1]);
    const top=sorted.slice(0,6);const others=sorted.slice(6).reduce((a,b)=>a+b[1],0);
    if(others) top.push(["OUTROS",others]);
    render("chart-transp","doughnut",{labels:top.map(x=>x[0]),datasets:[{data:top.map(x=>x[1])}]},{plugins:{tooltip:{callbacks:{label:c=>`${c.label}: ${c.raw} (${(c.raw/top.reduce((a,b)=>a+b[1],0)*100).toFixed(1)}%)`}}}});

    const hubMap={};d.forEach(x=>hubMap[x.hub]=(hubMap[x.hub]||0)+x.qtd);
    render("chart-hubs","bar",{labels:Object.keys(hubMap),datasets:[{data:Object.values(hubMap),backgroundColor:"#6366F1"}]},{plugins:{legend:{display:false}}});

    const hubs=Object.keys(hubMap);
    const am=hubs.map(h=>d.filter(x=>x.hub===h&&x.ciclo.includes("AM")).reduce((a,b)=>a+b.qtd,0));
    const dd=hubs.map(h=>d.filter(x=>x.hub===h&&x.ciclo.includes("DD")).reduce((a,b)=>a+b.qtd,0));
    render("chart-ciclo-hub","bar",{labels:hubs,datasets:[{label:"AM",data:am,backgroundColor:"#3B82F6"},{label:"DD",data:dd,backgroundColor:"#1E40AF"}]},{scales:{x:{stacked:true},y:{stacked:true}}});
}

init();
</script>
</body>
</html>
